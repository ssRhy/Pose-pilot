<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIå§¿åŠ¿å»ºè®®</title>
    <style>
      body {
        font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
      }
      .advice-box {
        background-color: #fff9c4;
        border-left: 4px solid #ffc107;
        padding: 20px;
        margin: 20px 0;
        border-radius: 0 4px 4px 0;
        transition: all 0.3s ease;
      }
      .advice-text {
        font-size: 18px;
        line-height: 1.6;
        color: #333;
      }
      .advice-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #1565c0;
        font-size: 20px;
      }
      .advice-icon {
        display: inline-block;
        margin-right: 8px;
        font-size: 22px;
      }
      .angles-box {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 4px 4px 0;
      }
      .angles-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #0d47a1;
        font-size: 18px;
      }
      .angle-data {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .angle-item {
        width: 48%;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
      }
      .angle-label {
        font-weight: bold;
        color: #555;
      }
      .angle-value {
        font-size: 24px;
        color: #2196f3;
        margin-top: 5px;
      }
      .bad-angle {
        color: #f44336;
      }
      .status-indicator {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .status-good {
        background-color: #e8f5e9;
        color: #4caf50;
      }
      .status-bad {
        background-color: #ffebee;
        color: #f44336;
      }
      button {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        display: block;
        margin: 20px auto;
        width: 200px;
      }
      button:hover {
        background-color: #0b7dda;
      }
      .loading {
        text-align: center;
        margin: 20px 0;
        font-style: italic;
        color: #666;
      }
      .auto-refresh {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
      }
      .refresh-toggle {
        margin-right: 10px;
      }
      .last-update {
        font-size: 12px;
        color: #666;
        text-align: center;
        margin-top: 5px;
      }
      .refresh-interval {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AIå§¿åŠ¿å»ºè®®å®æ—¶ç›‘æµ‹</h1>

      <div class="advice-box" id="adviceBox">
        <div class="advice-title">
          <span class="advice-icon">ğŸ’¡</span>æ™ºèƒ½å»ºè®®
        </div>
        <p class="advice-text" id="adviceText">
          ç‚¹å‡»"è·å–å»ºè®®"æŒ‰é’®æˆ–å¼€å¯è‡ªåŠ¨åˆ·æ–°è·å–AIç”Ÿæˆçš„å§¿åŠ¿å»ºè®®...
        </p>
      </div>

      <div class="angles-box" id="anglesBox" style="display: none">
        <div class="angles-title">å§¿åŠ¿æ•°æ®è¯¦æƒ…</div>
        <div id="postureStatus" class="status-indicator status-bad">
          å§¿åŠ¿çŠ¶æ€ï¼šä¸è‰¯
        </div>
        <div class="angle-data">
          <div class="angle-item">
            <div class="angle-label">é¢ˆéƒ¨è§’åº¦</div>
            <div id="neckAngle" class="angle-value">95Â°</div>
          </div>
          <div class="angle-item">
            <div class="angle-label">å·¦ä¾§èº«ä½“è§’åº¦</div>
            <div id="leftBodyAngle" class="angle-value">65Â°</div>
          </div>
          <div class="angle-item">
            <div class="angle-label">å³ä¾§èº«ä½“è§’åº¦</div>
            <div id="rightBodyAngle" class="angle-value">68Â°</div>
          </div>
          <div class="angle-item">
            <div class="angle-label">å¹³å‡èº«ä½“è§’åº¦</div>
            <div id="avgBodyAngle" class="angle-value">85Â°</div>
          </div>
        </div>
        <div class="last-update" id="lastUpdate"></div>
      </div>

      <button id="getAdviceBtn">è·å–å»ºè®®</button>
      <div id="loading" class="loading" style="display: none">
        æ­£åœ¨ç”Ÿæˆå»ºè®®ä¸­...
      </div>

      <div class="auto-refresh">
        <label class="refresh-toggle">
          <input type="checkbox" id="autoRefreshToggle" /> è‡ªåŠ¨åˆ·æ–°
        </label>
        <select id="refreshInterval" class="refresh-interval">
          <option value="5000">5ç§’</option>
          <option value="10000" selected>10ç§’</option>
          <option value="30000">30ç§’</option>
          <option value="60000">1åˆ†é’Ÿ</option>
        </select>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const adviceText = document.getElementById("adviceText");
        const anglesBox = document.getElementById("anglesBox");
        const postureStatus = document.getElementById("postureStatus");
        const neckAngle = document.getElementById("neckAngle");
        const leftBodyAngle = document.getElementById("leftBodyAngle");
        const rightBodyAngle = document.getElementById("rightBodyAngle");
        const avgBodyAngle = document.getElementById("avgBodyAngle");
        const lastUpdate = document.getElementById("lastUpdate");
        const getAdviceBtn = document.getElementById("getAdviceBtn");
        const loading = document.getElementById("loading");
        const autoRefreshToggle = document.getElementById("autoRefreshToggle");
        const refreshInterval = document.getElementById("refreshInterval");

        let refreshTimer = null;

        // äº‹ä»¶ç›‘å¬å™¨
        getAdviceBtn.addEventListener("click", getAdvice);
        autoRefreshToggle.addEventListener("change", toggleAutoRefresh);
        refreshInterval.addEventListener("change", updateRefreshInterval);

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–ä¸€æ¬¡æ•°æ®
        getAdvice();

        function getAdvice() {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (!refreshTimer) {
            adviceText.textContent = "æ­£åœ¨è·å–å»ºè®®...";
            loading.style.display = "block";
          }
          getAdviceBtn.disabled = true;

          // è°ƒç”¨APIè·å–å»ºè®® (ä½¿ç”¨é»˜è®¤çš„JSONæ ¼å¼)
          fetch("/get_advice")
            .then((response) => {
              if (!response.ok) {
                throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
              }
              return response.json();
            })
            .then((data) => {
              // æ˜¾ç¤ºè·å–åˆ°çš„å»ºè®®
              adviceText.textContent = data.advice;

              // æ˜¾ç¤ºè§’åº¦æ•°æ®
              anglesBox.style.display = "block";

              // æ›´æ–°å§¿åŠ¿çŠ¶æ€
              postureStatus.textContent =
                "å§¿åŠ¿çŠ¶æ€ï¼š" + (data.posture === "good" ? "è‰¯å¥½" : "ä¸è‰¯");
              postureStatus.className =
                "status-indicator " +
                (data.posture === "good" ? "status-good" : "status-bad");

              // æ›´æ–°è§’åº¦æ•°æ®
              const angles = data.angles;
              updateAngleDisplay(neckAngle, angles.neck, 90); // é¢ˆéƒ¨è§’åº¦è¶…è¿‡90åº¦é€šå¸¸ä¸å¥½
              updateAngleDisplay(leftBodyAngle, angles.left_body, 70); // èº«ä½“è§’åº¦è¶…è¿‡70åº¦é€šå¸¸ä¸å¥½
              updateAngleDisplay(rightBodyAngle, angles.right_body, 70);
              updateAngleDisplay(avgBodyAngle, angles.avg_body, 70);

              // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
              const now = new Date();
              lastUpdate.textContent = `æœ€åæ›´æ–°: ${now.toLocaleTimeString()}`;

              // éšè—åŠ è½½çŠ¶æ€
              loading.style.display = "none";
              getAdviceBtn.disabled = false;
            })
            .catch((error) => {
              console.error("Error:", error);
              adviceText.textContent = "è·å–å»ºè®®å¤±è´¥ï¼Œè¯·é‡è¯•";
              loading.style.display = "none";
              getAdviceBtn.disabled = false;
              anglesBox.style.display = "none";
            });
        }

        // è‡ªåŠ¨åˆ·æ–°åˆ‡æ¢
        function toggleAutoRefresh() {
          if (autoRefreshToggle.checked) {
            startAutoRefresh();
          } else {
            stopAutoRefresh();
          }
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
          if (refreshTimer) {
            clearInterval(refreshTimer);
          }
          const interval = parseInt(refreshInterval.value);
          refreshTimer = setInterval(getAdvice, interval);
          console.log(`è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ï¼Œé—´éš” ${interval / 1000} ç§’`);
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
          if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
            console.log("è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢");
          }
        }

        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateRefreshInterval() {
          if (autoRefreshToggle.checked) {
            startAutoRefresh(); // é‡æ–°å¯åŠ¨å®šæ—¶å™¨ä½¿ç”¨æ–°é—´éš”
          }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®é˜ˆå€¼æ›´æ–°è§’åº¦æ˜¾ç¤ºæ ·å¼
        function updateAngleDisplay(element, value, threshold) {
          element.textContent = value + "Â°";
          if (value > threshold) {
            element.classList.add("bad-angle");
          } else {
            element.classList.remove("bad-angle");
          }
        }
      });
    </script>
  </body>
</html>
