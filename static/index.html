<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>姿态监测系统 - AI姿势纠正建议</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap");

      body {
        font-family: "Montserrat", sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
      }

      .btn-primary {
        background: linear-gradient(45deg, #10b981 0%, #3b82f6 100%);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .status-good {
        background: linear-gradient(45deg, #10b981 0%, #34d399 100%);
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
      }

      .status-bad {
        background: linear-gradient(45deg, #ef4444 0%, #f87171 100%);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
      }

      .card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
      }

      #adviceBox {
        min-height: 100px;
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <header class="text-center mb-10">
        <h1
          class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-blue-500 mb-2"
        >
          智能姿态监测系统
        </h1>
        <p class="text-xl text-white/80">AI实时姿势检测与纠正建议</p>
      </header>

      <div class="grid md:grid-cols-12 gap-6">
        <!-- 左侧面板：摄像头和检测控制 -->
        <div class="md:col-span-7 card p-6">
          <h2 class="text-2xl font-bold mb-4">摄像头监测</h2>

          <!-- 摄像头显示区域 -->
          <div
            class="relative aspect-video bg-black/30 rounded-lg mb-4 overflow-hidden"
          >
            <img
              id="videoFeed"
              src=""
              alt="摄像头画面"
              class="w-full h-full object-cover"
            />
            <div
              id="loadingIndicator"
              class="absolute inset-0 flex items-center justify-center bg-black/50"
            >
              <div
                class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500"
              ></div>
            </div>
            <div
              id="statusBadge"
              class="absolute top-4 right-4 px-3 py-1 rounded-full text-white font-medium hidden"
            >
              等待检测...
            </div>
          </div>

          <!-- 控制按钮 -->
          <div class="flex flex-wrap gap-4 mb-6">
            <button
              id="startRTSP"
              class="btn-primary px-4 py-2 rounded-lg text-white font-medium"
            >
              开始RTSP检测
            </button>
            <button
              id="stopRTSP"
              class="btn-secondary px-4 py-2 rounded-lg text-white font-medium"
            >
              停止检测
            </button>
            <button
              id="captureBaseline"
              class="btn-secondary px-4 py-2 rounded-lg text-white font-medium"
            >
              记录标准姿势
            </button>
            <button
              id="getReport"
              class="btn-primary px-4 py-2 rounded-lg text-white font-medium"
            >
              获取姿势建议
            </button>
          </div>

          <!-- 姿势数据指标 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="p-3 rounded-lg bg-white/10">
              <p class="text-sm text-white/60">颈部角度</p>
              <p id="neckAngle" class="text-xl font-bold">--°</p>
            </div>
            <div class="p-3 rounded-lg bg-white/10">
              <p class="text-sm text-white/60">左侧身体角度</p>
              <p id="leftBodyAngle" class="text-xl font-bold">--°</p>
            </div>
            <div class="p-3 rounded-lg bg-white/10">
              <p class="text-sm text-white/60">右侧身体角度</p>
              <p id="rightBodyAngle" class="text-xl font-bold">--°</p>
            </div>
            <div class="p-3 rounded-lg bg-white/10">
              <p class="text-sm text-white/60">平均身体角度</p>
              <p id="avgBodyAngle" class="text-xl font-bold">--°</p>
            </div>
          </div>
        </div>

        <!-- 右侧面板：AI建议和操作日志 -->
        <div class="md:col-span-5 flex flex-col gap-6">
          <!-- AI建议卡片 -->
          <div class="card p-6 flex-grow">
            <h2 class="text-2xl font-bold mb-4">AI姿势建议</h2>
            <div id="adviceBox" class="bg-white/10 p-4 rounded-lg mb-4">
              <p class="text-white/80">AI将在此处显示针对您当前姿势的建议...</p>
            </div>
            <button
              id="testTTS"
              class="btn-secondary w-full py-2 rounded-lg text-white font-medium"
            >
              测试语音播报
            </button>
          </div>

          <!-- 操作日志卡片 -->
          <div class="card p-6">
            <h2 class="text-2xl font-bold mb-4">操作日志</h2>
            <div
              id="logBox"
              class="bg-black/30 p-4 rounded-lg h-40 overflow-y-auto text-sm"
            >
              <p class="text-white/60">系统就绪，等待操作...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // 获取DOM元素
        const videoFeed = document.getElementById("videoFeed");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const statusBadge = document.getElementById("statusBadge");
        const adviceBox = document.getElementById("adviceBox");
        const logBox = document.getElementById("logBox");
        const neckAngle = document.getElementById("neckAngle");
        const leftBodyAngle = document.getElementById("leftBodyAngle");
        const rightBodyAngle = document.getElementById("rightBodyAngle");
        const avgBodyAngle = document.getElementById("avgBodyAngle");

        // 按钮元素
        const startRTSPBtn = document.getElementById("startRTSP");
        const stopRTSPBtn = document.getElementById("stopRTSP");
        const captureBaselineBtn = document.getElementById("captureBaseline");
        const getReportBtn = document.getElementById("getReport");
        const testTTSBtn = document.getElementById("testTTS");

        // 添加日志的函数
        function addLog(message) {
          const logEntry = document.createElement("p");
          logEntry.className = "text-white/60 mb-1";
          logEntry.innerHTML = `<span class="text-emerald-400">[${new Date().toLocaleTimeString()}]</span> ${message}`;
          logBox.appendChild(logEntry);
          logBox.scrollTop = logBox.scrollHeight;
        }

        // 更新状态标签
        function updateStatus(status) {
          statusBadge.classList.remove("hidden", "status-good", "status-bad");
          if (status === "good") {
            statusBadge.classList.add("status-good");
            statusBadge.textContent = "姿势良好";
          } else if (status === "bad") {
            statusBadge.classList.add("status-bad");
            statusBadge.textContent = "姿势不良";
          } else {
            statusBadge.textContent = status;
          }
          statusBadge.classList.remove("hidden");
        }

        // 更新角度数据
        function updateAngles(angles) {
          if (!angles) return;

          neckAngle.textContent =
            angles.neck !== undefined ? `${angles.neck.toFixed(1)}°` : "--°";
          leftBodyAngle.textContent =
            angles.left_body !== undefined
              ? `${angles.left_body.toFixed(1)}°`
              : "--°";
          rightBodyAngle.textContent =
            angles.right_body !== undefined
              ? `${angles.right_body.toFixed(1)}°`
              : "--°";
          avgBodyAngle.textContent =
            angles.avg_body !== undefined
              ? `${angles.avg_body.toFixed(1)}°`
              : "--°";
        }

        // 显示AI建议
        function showAdvice(text) {
          adviceBox.innerHTML = `<p class="text-white">${text}</p>`;
        }

        // 开始RTSP检测
        startRTSPBtn.addEventListener("click", async () => {
          try {
            addLog("正在启动RTSP检测...");
            loadingIndicator.classList.remove("hidden");

            const response = await fetch("/rtsp/start", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}),
            });

            const data = await response.json();

            if (data.success) {
              addLog("RTSP检测已启动");
              loadingIndicator.classList.add("hidden");
              startPolling();
            } else {
              addLog(`启动失败: ${data.message || "未知错误"}`);
              loadingIndicator.classList.add("hidden");
            }
          } catch (error) {
            addLog(`错误: ${error.message}`);
            loadingIndicator.classList.add("hidden");
          }
        });

        // 停止RTSP检测
        stopRTSPBtn.addEventListener("click", async () => {
          try {
            addLog("正在停止RTSP检测...");

            const response = await fetch("/rtsp/stop", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            const data = await response.json();

            if (data.success) {
              addLog("RTSP检测已停止");
              stopPolling();
              videoFeed.src = "";
              updateStatus("已停止");
            } else {
              addLog(`停止失败: ${data.message || "未知错误"}`);
            }
          } catch (error) {
            addLog(`错误: ${error.message}`);
          }
        });

        // 记录标准姿势
        captureBaselineBtn.addEventListener("click", async () => {
          try {
            addLog("正在记录标准姿势...");
            loadingIndicator.classList.remove("hidden");

            const response = await fetch("/capture_baseline", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}),
            });

            const data = await response.json();

            if (data.success) {
              addLog("标准姿势已记录");
              updateAngles(data.angles);
            } else {
              addLog(`记录失败: ${data.error || "未知错误"}`);
            }

            loadingIndicator.classList.add("hidden");
          } catch (error) {
            addLog(`错误: ${error.message}`);
            loadingIndicator.classList.add("hidden");
          }
        });

        // 获取姿势建议
        getReportBtn.addEventListener("click", async () => {
          try {
            addLog("正在获取姿势建议...");

            const response = await fetch("/rtsp/report");
            const data = await response.json();

            if (data.success && data.result) {
              if (data.result.advice) {
                showAdvice(data.result.advice);
                addLog("已获取姿势建议");
              } else {
                addLog("当前姿势良好，无需建议");
              }
            } else {
              addLog(`获取建议失败: ${data.message || "未知错误"}`);
            }
          } catch (error) {
            addLog(`错误: ${error.message}`);
          }
        });

        // 测试语音播报
        testTTSBtn.addEventListener("click", async () => {
          try {
            addLog("正在测试语音播报...");

            const response = await fetch("/test_tts");
            const data = await response.json();

            if (data.report) {
              showAdvice(data.report);
              addLog("语音播报已发送");
            } else if (data.error) {
              addLog(`语音播报失败: ${data.error}`);
            }
          } catch (error) {
            addLog(`错误: ${error.message}`);
          }
        });

        // 轮询获取最新的RTSP结果
        let pollingInterval;

        function startPolling() {
          // 清除可能存在的旧轮询
          if (pollingInterval) clearInterval(pollingInterval);

          // 启动新轮询，每500ms检查一次
          pollingInterval = setInterval(async () => {
            try {
              const response = await fetch("/rtsp/latest");
              const data = await response.json();

              if (data.success && data.result) {
                const result = data.result;

                // 更新视频源
                if (result.image && videoFeed.src !== result.image) {
                  videoFeed.src = result.image;
                }

                // 更新姿势状态
                updateStatus(result.posture_status);

                // 更新角度数据
                updateAngles(result.angles);
              }
            } catch (error) {
              console.error("轮询错误:", error);
            }
          }, 500);
        }

        function stopPolling() {
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
          }
        }

        // 初始检查RTSP状态
        async function checkRTSPStatus() {
          try {
            const response = await fetch("/rtsp/status");
            const data = await response.json();

            if (data.running) {
              addLog("RTSP检测已在运行中");
              startPolling();
            }
          } catch (error) {
            console.error("检查RTSP状态失败:", error);
          }
        }

        // 页面加载时检查状态
        checkRTSPStatus();
      });
    </script>
  </body>
</html>
